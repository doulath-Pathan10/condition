import React from 'react';
import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
import OnboardingBeforeStart from './OnboardingBeforeStart';
import { getData, getPDFData } from '../../services/preApprovalServices';
import { useDispatch, useSelector } from 'react-redux';
import { getUrl } from '../../../../utils/common/change.utils';
import { CONSTANTS } from '../../../../utils/common/constants';

// Mock all external dependencies
jest.mock('../../services/preApprovalServices');
jest.mock('react-redux');
jest.mock('../../../../utils/common/change.utils');
jest.mock('../../../../utils/common/constants');

// Mock components
jest.mock('../../../../shared/components/pdf/pdf', () => () => <div>Mock PDF</div>);
jest.mock('../../../../shared/components/spinner/spinner', () => () => <div>Loading...</div>);

describe('OnboardingBeforeStart Component', () => {
  const mockDispatch = jest.fn();
  const mockOnScrollEnd = jest.fn();
  const mockNextPage = jest.fn();

  const mockStore = {
    stages: {
      stages: [{
        stageId: 'some-stage',
        stageInfo: {
          products: [{
            campaign: 'HKPIL23PLSTP10'
          }]
        }
      }]
    },
    preApproval: {
      formConfigmetaData: {
        products: [{
          campaign: 'HKPIL23PLSTP10'
        }]
      }
    }
  };

  // Mock window properties
  const originalWindowLocation = window.location;
  const originalNavigator = window.navigator;

  beforeAll(() => {
    Object.defineProperty(window, 'location', {
      configurable: true,
      value: { ...originalWindowLocation, host: 'example.com' }
    });
    Object.defineProperty(window, 'navigator', {
      configurable: true,
      value: { ...originalNavigator, userAgent: 'Mozilla/5.0' }
    });
  });

  afterAll(() => {
    Object.defineProperty(window, 'location', {
      configurable: true,
      value: originalWindowLocation
    });
    Object.defineProperty(window, 'navigator', {
      configurable: true,
      value: originalNavigator
    });
  });

  beforeEach(() => {
    (useDispatch as jest.Mock).mockReturnValue(mockDispatch);
    (useSelector as jest.Mock).mockImplementation((selector) => selector(mockStore));
    (getUrl.getLanguageInfo as jest.Mock).mockReturnValue('en');
    (CONSTANTS as any) = {
      LANG_EN: 'en',
      LANG_CN: 'zh',
      LANG_HK: 'hk',
      DownloadBtn: 'Download',
      DownloadBtn_CN: '下载',
      DownloadBtn_HK: '下載',
      DownloadHeader: 'Download Documents',
      DownloadHeader_CN: '下载文件',
      DownloadHeader_HK: '下載文件',
      ReadBtn: 'Read',
      ReadBtn_CN: '阅读',
      ReadBtn_HK: '閱讀',
      Remarks: 'Important Remarks',
      Remarks_CN: '重要备注',
      Remarks_HK: '重要備註',
      acceptButton: 'Accept',
      acceptButton_CN: '接受',
      acceptButton_HK: '接受'
    };
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  const setupComponent = (props = {}) => {
    const defaultProps = {
      isVisible: true,
      onScrollEnd: mockOnScrollEnd,
      stageID: 0,
      nextPage: mockNextPage,
      ...props
    };
    return render(<OnboardingBeforeStart {...defaultProps} />);
  };

  describe('Initial Load and Data Fetching', () => {
    it('should show spinner during initial load', () => {
      setupComponent();
      expect(screen.getByText('Loading...')).toBeInTheDocument();
    });

    it('should fetch KFS document for stage 0', async () => {
      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-pdf' }] },
          products: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-pdf' }] },
          tncLinkCampaignCode: {}
        }
      });
      (getPDFData as jest.Mock).mockResolvedValue('mock-pdf-data');

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(getData).toHaveBeenCalled();
        expect(getPDFData).toHaveBeenCalledWith('https://pt.sc.com/desktop-pdf');
        expect(mockDispatch).toHaveBeenCalledTimes(3); // setLoader, setKfsDocumentPdf, setLoader
        expect(mockOnScrollEnd).toHaveBeenCalledWith(true);
      });
    });

    it('should fetch mobile KFS document when on mobile device', async () => {
      Object.defineProperty(window.navigator, 'userAgent', {
        value: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)',
        writable: true
      });

      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-pdf' }] },
          products: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-pdf' }] },
          tncLinkCampaignCode: {}
        }
      });

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(getPDFData).toHaveBeenCalledWith('https://pt.sc.com/mobile-pdf');
      });
    });

    it('should handle localhost URL replacement', async () => {
      Object.defineProperty(window, 'location', {
        value: { ...window.location, host: 'localhost:3000' }
      });

      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-pdf' }] },
          products: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-pdf' }] },
          tncLinkCampaignCode: {}
        }
      });

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(getPDFData).toHaveBeenCalledWith('http://localhost:3000/desktop-pdf');
      });
    });

    it('should fetch T&C document for stage 1', async () => {
      (getData as jest.Mock).mockResolvedValue({
        data: {
          CampaignTnCMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-tnc' }] },
          CampaignTnC: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-tnc' }] },
          tncLinkCampaignCode: {
            HKPIL23PLSTP10: [{
              pdfLinks: [
                { Title: 'II. Personal Loan Terms', url: 'mock-url-1' },
                { Title: 'III. Client Terms', url: 'mock-url-2' }
              ]
            }]
          }
        }
      });

      setupComponent({ stageID: 1 });

      await waitFor(() => {
        expect(getPDFData).toHaveBeenCalledWith('https://pt.sc.com/desktop-tnc');
        expect(mockDispatch).toHaveBeenCalledWith(
          preApprovalAction.setTandCDocumentPdf('https://pt.sc.com/desktop-tnc')
        );
        expect(mockDispatch).toHaveBeenCalledWith(
          preApprovalAction.setDownloadPDFData('mock-pdf-data')
        );
      });
    });

    it('should handle Chinese language documents', async () => {
      (getUrl.getLanguageInfo as jest.Mock).mockReturnValue('zh');
      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-pdf' }] },
          products: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-pdf' }] },
          tncLinkCampaignCode: {}
        }
      });

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(getData).toHaveBeenCalledWith(process.env.REACT_APP_KFS_DOC_URL_Chinees);
      });
    });
  });

  describe('PDF Download Functionality', () => {
    beforeEach(() => {
      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/mobile-pdf' }] },
          products: { HKPIL23PLSTP10: [{ pdfURL: 'https://pt.sc.com/desktop-pdf' }] },
          tncLinkCampaignCode: {
            HKPIL23PLSTP10: [{
              pdfLinks: [
                { Title: 'II. Personal Loan Terms', url: 'mock-url-1' },
                { Title: 'III. Client Terms', url: 'mock-url-2' }
              ]
            }]
          }
        }
      });
      (getPDFData as jest.Mock).mockResolvedValue('mock-pdf-data');
    });

    it('should download KFS PDF when download button is clicked', async () => {
      const createElementSpy = jest.spyOn(document, 'createElement');
      const appendChildSpy = jest.spyOn(document.body, 'appendChild');
      const removeChildSpy = jest.spyOn(document.body, 'removeChild');

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        const downloadButton = screen.getByText('Download');
        fireEvent.click(downloadButton);

        expect(createElementSpy).toHaveBeenCalledWith('a');
        expect(appendChildSpy).toHaveBeenCalled();
        expect(removeChildSpy).toHaveBeenCalled();
      });
    });

    it('should handle Safari browser for PDF download', async () => {
      Object.defineProperty(window.navigator, 'userAgent', {
        value: 'Safari',
        writable: true
      });

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        const downloadButton = screen.getByText('Download');
        fireEvent.click(downloadButton);
      });
    });

    it('should download terms PDF when download link is clicked (PIL campaign)', async () => {
      setupComponent({ stageID: 1 });

      await waitFor(() => {
        const downloadLinks = screen.getAllByText('Download');
        fireEvent.click(downloadLinks[0]);
      });
    });

    it('should download terms PDF when download link is clicked (CC campaign)', async () => {
      const ccMockStore = {
        ...mockStore,
        stages: {
          stages: [{
            stageId: 'some-stage',
            stageInfo: {
              products: [{
                campaign: 'HKSOG20VAWV000'
              }]
            }
          }]
        },
        preApproval: {
          formConfigmetaData: {
            products: [{
              campaign: 'HKSOG20VAWV000'
            }]
          }
        }
      };

      (useSelector as jest.Mock).mockImplementation((selector) => selector(ccMockStore));

      (getData as jest.Mock).mockResolvedValue({
        data: {
          CampaignTnCMob: { HKSOG20VAWV000: [{ pdfURL: 'https://pt.sc.com/mobile-tnc' }] },
          CampaignTnC: { HKSOG20VAWV000: [{ pdfURL: 'https://pt.sc.com/desktop-tnc' }] },
          tncLinkCampaignCode: {
            HKSOG20VAWV000: [{
              pdfLinks: [
                { Title: 'III. Client Terms', url: 'mock-url-1' },
                { Title: 'III. Credit Card Terms', url: 'mock-url-2' }
              ]
            }]
          }
        }
      });

      setupComponent({ stageID: 1 });

      await waitFor(() => {
        const downloadLinks = screen.getAllByText('Download');
        fireEvent.click(downloadLinks[0]); // III. Client Terms
        fireEvent.click(downloadLinks[1]); // III. Credit Card Terms
      });
    });
  });

  describe('Scroll Behavior', () => {
    it('should call onScrollEnd when scrolled to bottom', async () => {
      const mockRef = {
        current: {
          addEventListener: jest.fn((event, callback) => {
            if (event === 'scroll') {
              // Simulate scroll event
              setTimeout(() => callback(), 100);
            }
          }),
          removeEventListener: jest.fn(),
          scrollTop: 100,
          scrollHeight: 200,
          clientHeight: 100
        }
      };

      jest.spyOn(React, 'useRef').mockReturnValue(mockRef);

      setupComponent({ stageID: 0 });

      await act(async () => {
        await new Promise(resolve => setTimeout(resolve, 150));
      });

      expect(mockOnScrollEnd).toHaveBeenCalledWith(false);
    });

    it('should scroll down when footer button is clicked (stage 0)', async () => {
      const mockScrollBy = jest.fn();
      const mockRef = {
        current: {
          addEventListener: jest.fn(),
          removeEventListener: jest.fn(),
          scrollBy: mockScrollBy
        }
      };

      jest.spyOn(React, 'useRef').mockReturnValue(mockRef);

      setupComponent({ stageID: 0, isVisible: true });

      await waitFor(() => {
        const scrollButton = screen.getByRole('button', { name: /scroll/i });
        fireEvent.click(scrollButton);
        expect(mockScrollBy).toHaveBeenCalledWith({ top: 200, behavior: 'smooth' });
      });
    });

    it('should scroll down when footer button is clicked (stage 1)', async () => {
      const mockScrollBy = jest.fn();
      const mockRef = {
        current: {
          addEventListener: jest.fn(),
          removeEventListener: jest.fn(),
          scrollBy: mockScrollBy
        }
      };

      jest.spyOn(React, 'useRef').mockReturnValue(mockRef);

      setupComponent({ stageID: 1, isVisible: true });

      await waitFor(() => {
        const scrollButton = screen.getByRole('button', { name: /scroll/i });
        fireEvent.click(scrollButton);
        expect(mockScrollBy).toHaveBeenCalledWith({ top: 5000, behavior: 'smooth' });
      });
    });

    it('should show accept button when not visible', async () => {
      setupComponent({ isVisible: false });

      await waitFor(() => {
        const acceptButton = screen.getByText('Accept');
        fireEvent.click(acceptButton);
        expect(mockNextPage).toHaveBeenCalled();
      });
    });
  });

  describe('Language Handling', () => {
    it('should display English text by default', async () => {
      (getUrl.getLanguageInfo as jest.Mock).mockReturnValue('en');
      setupComponent({ stageID: 1 });

      await waitFor(() => {
        expect(screen.getByText('Download Documents')).toBeInTheDocument();
        expect(screen.getByText('Read')).toBeInTheDocument();
        expect(screen.getByText('Download')).toBeInTheDocument();
        expect(screen.getByText('Important Remarks')).toBeInTheDocument();
      });
    });

    it('should display Chinese text when language is zh', async () => {
      (getUrl.getLanguageInfo as jest.Mock).mockReturnValue('zh');
      setupComponent({ stageID: 1 });

      await waitFor(() => {
        expect(screen.getByText('下载文件')).toBeInTheDocument();
        expect(screen.getByText('阅读')).toBeInTheDocument();
        expect(screen.getByText('下载')).toBeInTheDocument();
        expect(screen.getByText('重要备注')).toBeInTheDocument();
      });
    });

    it('should display Hong Kong text when language is hk', async () => {
      (getUrl.getLanguageInfo as jest.Mock).mockReturnValue('hk');
      setupComponent({ stageID: 1 });

      await waitFor(() => {
        expect(screen.getByText('下載文件')).toBeInTheDocument();
        expect(screen.getByText('閱讀')).toBeInTheDocument();
        expect(screen.getByText('下載')).toBeInTheDocument();
        expect(screen.getByText('重要備註')).toBeInTheDocument();
      });
    });
  });

  describe('Error Handling', () => {
    it('should handle API errors gracefully', async () => {
      (getData as jest.Mock).mockRejectedValue(new Error('API Error'));

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(mockDispatch).toHaveBeenCalledWith(expect.any(Function));
      });
    });

    it('should handle empty PDF links', async () => {
      (getData as jest.Mock).mockResolvedValue({
        data: {
          productsMob: { HKPIL23PLSTP10: [] },
          products: { HKPIL23PLSTP10: [] },
          tncLinkCampaignCode: {}
        }
      });

      setupComponent({ stageID: 0 });

      await waitFor(() => {
        expect(mockDispatch).toHaveBeenCalled();
      });
    });
  });
});
